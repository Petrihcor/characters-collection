{% extends 'base.html.twig' %}

{% block title %}Tournament Bracket{% endblock %}

{% block body %}
    <h1>Tournament Bracket</h1>


    <!-- –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Ç—É—Ä–Ω–∏—Ä–∞ -->
    <div class="bracket">
        <h2>Current Bracket</h2>
        {% set sorted_bracket = bracket|keys|sort %} {# –ü–æ–ª—É—á–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ #}

        {% for level in sorted_bracket %}
            <div class="level" id="level-{{ level }}">
                <h3>Level {{ level }}</h3>
                <div class="players">
                    {% for player in bracket[level] %}
                        <div class="player">
                            <span>{{ player.getName() }}</span>
                            {% for stat in tournament.stats %}
                                <span class="stat">{{ stat|capitalize }}: {{ attribute(player, stat) }}</span>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

{#        <form action="{{ path('choose_participans', {id: tournament.id}) }}" method="post">#}
{#            <button type="submit">–ü–æ–¥–±–æ—Ä —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤</button>#}
{#        </form>#}
    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –±–æ—è -->

    {% if bracket is empty %}
        <form action="{{ path('stop_tournament', {id: id}) }}" method="post">
            <button type="submit" class="reset-button">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä</button>
        </form>
    {% else %}
        <button id="openFightModal">–ü–æ–¥–±–æ—Ä —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤</button>
    {% endif %}
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±–æ—è -->
    <div id="fightModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>–ë–æ–π</h2>
            <div id="fightersContainer">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–æ–≤...</p>
            </div>
            <button id="startFight">–ù–∞—á–∞—Ç—å –±–æ–π</button>
        </div>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞ -->
{#    <form action="{{ path('tournament_reset', {id: id}) }}" method="post">#}
{#        <button type="submit" class="reset-button">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä</button>#}
{#    </form>#}

    <!-- –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Å—Ç–∞ -->
    <div class="places">
        <h2>Final Places</h2>
        <table>
            <thead>
            <tr>
                <th>–ú–µ—Å—Ç–æ</th>
                <th>–ò–≥—Ä–æ–∫</th>
            </tr>
            </thead>
            <tbody>
            {% for placeData in places|sort((a, b) => a.place <=> b.place) %}
                <tr>
                    <td>{{ placeData.place }}</td>
                    <td>{{ placeData.character.name }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const modal = document.getElementById("fightModal");
            const openModalBtn = document.getElementById("openFightModal");
            const closeModalBtn = document.querySelector(".close");
            const startFightBtn = document.getElementById("startFight");
            const fightersContainer = document.getElementById("fightersContainer");

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –±–æ–π—Ü–æ–≤
            openModalBtn.addEventListener("click", function () {
                modal.style.display = "block";
                fetch("{{ path('choose_participans', {id: tournament.id}) }}", { method: "POST" })
                    .then(response => response.json())
                    .then(data => {
                        fightersContainer.innerHTML = ""; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –±–æ–π—Ü–∞–º–∏
                        data.fighters.forEach(fighter => {
                            let statsHtml = "";
                            Object.entries(fighter).forEach(([key, value]) => {
                                if (key !== "id" && key !== "name" && key !== "image") { // –ò—Å–∫–ª—é—á–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
                                    statsHtml += `<p>${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}</p>`;
                                }
                            });

                            let fighterHtml = `
                                <div class="character-card" style="background-image: url('/images/${fighter.image}');">
                                    <div class="character-info">
                                        <h3 class="character-name">${fighter.name}</h3>
                                        ${Object.entries(fighter)
                                                            .filter(([key]) => key !== "id" && key !== "name" && key !== "image")
                                                            .map(([key, value]) => `<p class="character-stat">${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}</p>`)
                                                            .join("")}
                                    </div>
                                    <input type="hidden" name="fighters[]" value="${fighter.id}">
                                </div>
                            `;

                            fightersContainer.innerHTML += fighterHtml;
                        });

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º level –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
                        window.currentLevel = data.level; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—Ä–æ–≤–µ–Ω—å –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                    });
            });

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            closeModalBtn.addEventListener("click", function () {
                modal.style.display = "none";
            });

            startFightBtn.addEventListener("click", function (event) {
                event.preventDefault();

                const formData = new FormData();
                document.querySelectorAll('input[name="fighters[]"]').forEach(input => {
                    formData.append("fighters[]", input.value);
                });
                formData.append("level", window.currentLevel);

                fetch("{{ path('fight', {id: tournament.id}) }}", {
                    method: "POST",
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.winner) {
                            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                            fightersContainer.innerHTML = `
            <h3>üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${data.winner.name} üèÜ</h3>
            <img src="/images/${data.winner.image}" alt="${data.winner.name}" style="width:150px; height:150px; border-radius:50%;">
        `;
                        } else {
                            // –ï—Å–ª–∏ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ç–∫—É
                            setTimeout(() => {
                                updateBracket(data.newBracket);
                            }, 100);
                        }

                        // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                        setTimeout(() => {
                            modal.style.display = "none";
                            location.reload(); // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
                        }, 3000);
                    });
            });


        });

    </script>
{% endblock %}
