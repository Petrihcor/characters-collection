{% extends 'base.html.twig' %}

{% block title %}Tournament Bracket{% endblock %}

{% block body %}
    <h1>Tournament Bracket</h1>

    <!-- Лог боя -->
    <div class="logs">
        <h2>Logs</h2>
        <ul>
            {% for log in logs %}
                <li>{{ log }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Текущий уровень турнира -->
    <div class="bracket">
        <h2>Current Bracket</h2>
        {% set sorted_levels = levels|keys|sort %} {# Получаем отсортированные ключи #}

        {% for level in sorted_levels %}
            <div class="level" id="level-{{ level }}">
                <h3>Level {{ level }}</h3>
                <div class="players">
                    {% for player in levels[level] %}
                        <div class="player">
                            <span>{{ player.getName() }}</span>
                            {% for stat in stats %}
                                <span class="stat">{{ stat|capitalize }}: {{ attribute(player, stat) }}</span>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>

{#    <form action="{{ path('start_fight', {id: id}) }}" method="post">#}
{#        <button type="submit">Подбор соперников</button>#}
{#    </form>#}
    <!-- Кнопка вызова модального окна для боя -->
    <button id="openFightModal">Подбор соперников</button>

    <!-- Модальное окно для боя -->
    <div id="fightModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Бой</h2>
            <div id="fightersContainer">
                <p>Загрузка соперников...</p>
            </div>
            <button id="startFight">Начать бой</button>
        </div>
    </div>
    <!-- Кнопка запуска следующего раунда -->
    <form action="{{ path('tournament_reset', {id: id}) }}" method="post">
        <button type="submit" class="reset-button">Очистить турнир</button>
    </form>

    <!-- Итоговые места -->
    <div class="places">
        <h2>Final Places</h2>
        <table>
            <thead>
            <tr>
                <th>Место</th>
                <th>Игрок</th>
                {% for stat in stats %}
                    <th>{{ stat }}</th>
                {% endfor %}
            </tr>
            </thead>
            <tbody>
            {% for player in places %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ player.getName() }}</td>
                    {% for stat in stats %}
                        <td>{{ attribute(player, 'get' ~ stat) }}</td>
                    {% endfor %}

                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const modal = document.getElementById("fightModal");
            const openModalBtn = document.getElementById("openFightModal");
            const closeModalBtn = document.querySelector(".close");
            const startFightBtn = document.getElementById("startFight");
            const fightersContainer = document.getElementById("fightersContainer");

            // Открываем модалку и подгружаем бойцов
            openModalBtn.addEventListener("click", function () {
                modal.style.display = "block";
                console.log("Отправка запроса на:", "{{ path('start_fight', {id: id}) }}");
                fetch("{{ path('start_fight', {id: id}) }}", { method: "POST" })
                    .then(response => response.json())
                    .then(data => {
                        fightersContainer.innerHTML = "";
                        data.fighters.forEach(fighter => {
                            fightersContainer.innerHTML += `
                <div class="fighter-card">
                    <h3>${fighter.name}</h3>
                    <p>Сила: ${fighter.strength}</p>
                    <p>Ловкость: ${fighter.agility}</p>
                    <input type="hidden" name="fighters[]" value="${fighter.id}">
                </div>
            `;
                        });
                    });
            });

            // Закрываем модалку
            closeModalBtn.addEventListener("click", function () {
                modal.style.display = "none";
            });

            // Начинаем бой
            startFightBtn.addEventListener("click", function () {
                const formData = new FormData();
                document.querySelectorAll('input[name="fighters[]"]').forEach(input => {
                    formData.append("fighters[]", input.value);
                });

                fetch("{{ path('tournament_next_fight', {id: id}) }}", {
                    method: "POST",
                    body: formData
                }).then(() => {
                    location.reload(); // Обновляем страницу после боя
                });
            });
        });
    </script>
{% endblock %}
